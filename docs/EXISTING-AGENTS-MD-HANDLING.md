# Handling Existing AGENTS.md Files

**Version:** 1.1.0  
**Date:** 2025-12-23  
**Status:** Production Ready

---

## Overview

This document explains how the agents-md-generator SOP handles existing `AGENTS.md` files in target folders. The tool **does NOT** blindly overwrite existing files - it checks first and handles them appropriately.

---

## Behavior Summary

### Current Behavior (v1.1.0)

1. **Check Before Writing:** The tool checks if `AGENTS.md` exists before generating
2. **Detect Source:** Determines if existing file was generated by this tool or manually created
3. **Appropriate Action:** Takes different actions based on file source:
   - **Tool-generated:** Backup existing file, then overwrite
   - **Manually created:** **STOP** and request user decision (backup/abort)
   - **Not exists:** Proceed normally

### No Merge, No Append

- **Merge:** Not supported (would require complex conflict resolution)
- **Append:** Not supported (AGENTS.md is a complete document, not appendable)
- **Replace:** Only if file was generated by this tool (with backup)

---

## Detection Logic

The tool uses `executions/check-existing-agents-md.py` to detect existing files and determine their source.

### Tool-Generated File Indicators

A file is considered "tool-generated" if it contains:

1. **Frontmatter markers:**
   - `agents-md-generator` in frontmatter
   - `progressive context loading` in frontmatter

2. **Tool-specific sections:**
   - `## üéØ CONTEXT: Progressive Context Loading Protocol`
   - `Level 1: Front Matter` and `Level 2: AGENTS.md Content` sections

3. **Generated timestamp:**
   - Pattern: `Generated.*YYYY-MM-DD`

### Manually Created File Indicators

If none of the above indicators are found, the file is considered "manually created" and should **NOT** be overwritten without explicit user confirmation.

---

## Error Handling Process

### Scenario 1: AGENTS.md Does Not Exist

**Action:** Proceed normally with generation

**Exit Code:** 0

**Message:** "AGENTS.md does not exist - safe to proceed"

---

### Scenario 2: AGENTS.md Exists and Was Generated by This Tool

**Action:** 
1. Create backup: `AGENTS.md.backup.[timestamp]`
2. Proceed with overwrite

**Exit Code:** 1

**Message:** "AGENTS.md exists and was generated by this tool - can backup and overwrite"

**Example Backup Name:** `AGENTS.md.backup.20251223_143022`

---

### Scenario 3: AGENTS.md Exists and Was Manually Created

**Action:** 
1. **STOP execution**
2. Report error to user
3. Request user decision:
   - **Option 1:** Backup and overwrite (user confirms)
   - **Option 2:** Abort (do not overwrite)
   - **Option 3:** Merge (not supported yet - request backup/abort)

**Exit Code:** 2

**Message:** "AGENTS.md exists and appears to be manually created - should NOT overwrite"

**User Decision Required:** Yes

---

## Usage Examples

### Example 1: Check Before Generation

```bash
# Check if AGENTS.md exists
python executions/check-existing-agents-md.py __ref/interview-framework

# Output (if tool-generated):
{
  "exists": true,
  "status": "tool_generated",
  "path": "__ref/interview-framework/AGENTS.md",
  "message": "AGENTS.md exists and was generated by this tool - can backup and overwrite",
  "can_overwrite": true
}

# Exit code: 1
```

### Example 2: Manual File Detection

```bash
# Check if AGENTS.md exists
python executions/check-existing-agents-md.py __ref/my-folder

# Output (if manually created):
{
  "exists": true,
  "status": "manually_created",
  "path": "__ref/my-folder/AGENTS.md",
  "message": "AGENTS.md exists and appears to be manually created - should NOT overwrite",
  "can_overwrite": false
}

# Exit code: 2
```

---

## Integration with Phase 3

Phase 3 of the SOP workflow now includes:

1. **Pre-Write Check:**
   ```bash
   python executions/check-existing-agents-md.py [TARGET_FOLDER_PATH]
   ```

2. **Decision Logic:**
   - Exit code 0 ‚Üí Proceed normally
   - Exit code 1 ‚Üí Backup existing file, proceed with overwrite
   - Exit code 2 ‚Üí **STOP**, report error, request user decision

3. **Backup Creation:**
   - If tool-generated: Automatically create backup
   - If manually created: Request user confirmation before backup

---

## Best Practices

### For Users

1. **Check before running:** If you have a manually created AGENTS.md, review it before running the generator
2. **Backup manually:** If you want to keep your manual AGENTS.md, rename it before running
3. **Review backups:** Check backup files if you need to restore previous versions

### For AI Agents

1. **Always check first:** Run `check-existing-agents-md.py` before Phase 3
2. **Respect manual files:** Never overwrite manually created AGENTS.md without user confirmation
3. **Report clearly:** Clearly communicate file status and required actions to user

---

## Future Enhancements

### Planned (Not Yet Implemented)

1. **Merge Support:** Intelligent merging of tool-generated and manually created content
2. **Diff Preview:** Show differences between existing and new AGENTS.md before overwrite
3. **Selective Update:** Update only specific sections while preserving manual edits
4. **Version Control:** Track AGENTS.md versions and changes over time

### Not Planned

- **Append Mode:** AGENTS.md is a complete document, not suitable for appending
- **Automatic Merge:** Too complex and error-prone without user review

---

## Troubleshooting

### Issue: "AGENTS.md exists and appears to be manually created"

**Solution:**
1. Review existing AGENTS.md
2. If you want to keep it: Rename it (e.g., `AGENTS.md.manual`)
3. If you want to replace it: Confirm backup and overwrite
4. If you want to merge: Not supported yet - manually merge or use backup

### Issue: "Failed to create backup"

**Solution:**
1. Check file permissions
2. Check disk space
3. Verify folder is writable
4. Try manual backup: `cp AGENTS.md AGENTS.md.backup`

---

## Summary

**Key Points:**
- ‚úÖ Tool checks for existing AGENTS.md before writing
- ‚úÖ Tool detects if file was generated by tool or manually created
- ‚úÖ Tool-generated files: Auto-backup and overwrite
- ‚úÖ Manually created files: STOP and request user decision
- ‚ùå No merge (not supported)
- ‚ùå No append (not supported)
- ‚úÖ Backup created automatically for tool-generated files

**Safety:** The tool will **never** overwrite manually created AGENTS.md files without explicit user confirmation.

---

**Version:** 1.1.0  
**Last Updated:** 2025-12-23  
**Status:** Production Ready

